<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“¦ QR Code Inventory Scanner (Offline Excel)</title>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f9fb;
    text-align: center;
    padding: 20px;
  }

  h2 {
    color: #333;
  }

  #reader {
    width: 360px;
    height: 360px;
    margin: 20px auto;
    border: 3px solid #007bff;
    border-radius: 15px;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.15);
  }

  #status {
    margin-top: 10px;
    color: #333;
    font-size: 16px;
    font-weight: 500;
  }

  button {
    padding: 12px 20px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    margin: 8px;
    color: white;
    background-color: #007bff;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button:hover {
    background-color: #0056b3;
  }

  button:disabled {
    background-color: #999;
  }

  @media (max-width: 480px) {
    #reader {
      width: 280px;
      height: 280px;
    }
  }
</style>
</head>
<body>

  <h2>ðŸ“¦ QR Code Inventory Scanner (Offline Excel)</h2>
  <div id="reader"></div>
  <p id="status">Click "Start Scanning" to begin.</p>

  <button id="startButton">Start Scanning</button>
  <button id="stopButton" disabled>Stop Scanning</button>
  <button id="downloadButton">ðŸ“¥ Download Excel</button>

<script>
const html5QrCode = new Html5Qrcode("reader");
const startButton = document.getElementById("startButton");
const stopButton = document.getElementById("stopButton");
const downloadButton = document.getElementById("downloadButton");
const status = document.getElementById("status");

let isScanning = false;
let cameraId = null;
let scannedData = []; // store all scans

async function startScanner() {
  try {
    const cameras = await Html5Qrcode.getCameras();
    if (!cameras || cameras.length === 0) {
      status.textContent = "âŒ No camera found on this device.";
      return;
    }

    const backCamera = cameras.find(cam => /back|rear|environment/i.test(cam.label)) || cameras[0];
    cameraId = backCamera.id;

    await html5QrCode.start(
      { deviceId: { exact: cameraId } },
      { fps: 10, qrbox: { width: 320, height: 320 } },
      (decodedText) => {
        const timestamp = new Date().toLocaleString();
        scannedData.push({ "Scanned Code": decodedText, "Time": timestamp });
        status.textContent = `âœ… Scanned: ${decodedText}`;
      },
      () => {}
    );

    status.textContent = "ðŸ“· Scanning... Align QR inside the box.";
    isScanning = true;
    startButton.disabled = true;
    stopButton.disabled = false;

  } catch (err) {
    console.error("Camera error:", err);
    status.textContent = "âš ï¸ Allow camera access in browser settings.";
  }
}

async function stopScanner() {
  if (isScanning) {
    await html5QrCode.stop();
    isScanning = false;
    startButton.disabled = false;
    stopButton.disabled = true;
    status.textContent = "Scanner stopped.";
  }
}

// Function to download data as Excel
function downloadExcel() {
  if (scannedData.length === 0) {
    alert("No scanned data to export!");
    return;
  }

  const worksheet = XLSX.utils.json_to_sheet(scannedData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Scanned Data");

  const currentDate = new Date().toISOString().split("T")[0];
  XLSX.writeFile(workbook, `QR_Scan_Report_${currentDate}.xlsx`);
}

startButton.addEventListener("click", async () => {
  await startScanner();
});

stopButton.addEventListener("click", stopScanner);
downloadButton.addEventListener("click", downloadExcel);
</script>
</body>
</html>
