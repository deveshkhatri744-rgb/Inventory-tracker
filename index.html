<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì¶ QR Code Excel Logger</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f9fb;
    text-align: center;
    padding: 20px;
  }
  #reader {
    width: 320px;
    height: 260px;
    margin: 20px auto;
    border: 2px solid #0078d7;
    border-radius: 10px;
    background: white;
  }
  button {
    padding: 10px 20px;
    margin: 10px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
  }
  #startBtn { background: #0078d7; }
  #stopBtn { background: #ff4c4c; }
  #downloadBtn { background: #28a745; display: none; }
  #status { font-weight: bold; color: #0078d7; margin-top: 15px; }
</style>
</head>
<body>

<h2>üì¶ QR Sale Scanner ‚Üí Excel Export</h2>
<div id="reader"></div>
<p id="status">Click Start to scan QR codes.</p>
<button id="startBtn">Start Scanner</button>
<button id="stopBtn" disabled>Stop Scanner</button>
<button id="downloadBtn">Download Excel</button>

<script>
let html5QrCode;
let isScanning = false;
let scannedData = [["Timestamp", "Product / QR Data"]]; // Excel header row

document.getElementById("startBtn").addEventListener("click", startScanner);
document.getElementById("stopBtn").addEventListener("click", stopScanner);
document.getElementById("downloadBtn").addEventListener("click", downloadExcel);

async function startScanner() {
  const status = document.getElementById("status");
  html5QrCode = new Html5Qrcode("reader");
  status.textContent = "üì∑ Initializing camera...";

  try {
    const cameras = await Html5Qrcode.getCameras();
    if (cameras && cameras.length) {
      const backCam = cameras.find(cam => /back|rear|environment/i.test(cam.label)) || cameras[0];
      await html5QrCode.start(
        backCam.id,
        { fps: 10, qrbox: { width: 260, height: 260 } },
        qrMessage => {
          const now = new Date().toLocaleString();
          scannedData.push([now, qrMessage]);
          status.textContent = `‚úÖ Scanned: ${qrMessage}`;
          console.log("Logged:", now, qrMessage);

          // Pause for 2 seconds between scans
          html5QrCode.pause();
          setTimeout(() => {
            html5QrCode.resume();
            status.textContent = "üì∑ Ready for next scan...";
          }, 1500);
        }
      );
      isScanning = true;
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
      document.getElementById("downloadBtn").style.display = "none";
      status.textContent = "üì∑ Point camera at a QR code.";
    } else {
      status.textContent = "‚ùå No camera found!";
    }
  } catch (err) {
    console.error(err);
    status.textContent = "‚ö†Ô∏è Camera access error.";
  }
}

async function stopScanner() {
  if (isScanning && html5QrCode) {
    await html5QrCode.stop();
    isScanning = false;
    document.getElementById("status").textContent = "‚èπÔ∏è Scanner stopped.";
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
    document.getElementById("downloadBtn").style.display = "inline-block";
  }
}

function downloadExcel() {
  const ws = XLSX.utils.aoa_to_sheet(scannedData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sales Log");

  const now = new Date();
  const fileName = `Sales_Log_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.xlsx`;

  XLSX.writeFile(wb, fileName);
  document.getElementById("status").textContent = "‚úÖ Excel file downloaded!";
}
</script>

</body>
</html>

