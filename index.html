<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“¦ QR Code Inventory Scanner</title>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f9fb;
    text-align: center;
    padding: 20px;
  }
  h2 { color: #333; }
  #reader {
    width: 300px;
    height: 300px;
    margin: 20px auto;
    border: 2px solid #007bff;
    border-radius: 10px;
    background: white;
  }
  #status {
    margin-top: 10px;
    color: #333;
  }
  button {
    padding: 10px 18px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    margin: 8px;
    color: white;
    background-color: #007bff;
    cursor: pointer;
  }
  button:disabled {
    background-color: #999;
  }
</style>
</head>
<body>
  <h2>ðŸ“¦ QR Code Inventory Scanner</h2>
  <div id="reader"></div>
  <p id="status">Click "Start Scanning" to begin.</p>
  <button id="startButton">Start Scanning</button>
  <button id="stopButton" disabled>Stop Scanning</button>

<script>
const html5QrCode = new Html5Qrcode("reader");
const startButton = document.getElementById("startButton");
const stopButton = document.getElementById("stopButton");
const status = document.getElementById("status");

const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZs18oHhoglSsUDYbX8Z0PXGGmgCu85ZC2x46nGGEiBHF84vWU2aKnjuO6US_mSXqzag/exec";

let isScanning = false;
let cameraId = null;

async function startScanner() {
  try {
    const cameras = await Html5Qrcode.getCameras();
    if (!cameras || cameras.length === 0) {
      status.textContent = "âŒ No camera found on this device.";
      return;
    }

    // Prefer back camera if available
    const backCamera = cameras.find(cam => /back|rear|environment/i.test(cam.label)) || cameras[0];
    cameraId = backCamera.id;

    await html5QrCode.start(
      { deviceId: { exact: cameraId } },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      (decodedText, decodedResult) => {
        status.textContent = "âœ… Scanned: " + decodedText;
        sendToSheet(decodedText);
        stopScanner();
      },
      (errorMessage) => {}
    );

    status.textContent = "ðŸ“· Scanning... Align QR inside the box.";
    isScanning = true;
    startButton.disabled = true;
    stopButton.disabled = false;

  } catch (err) {
    console.error("Camera error:", err);
    status.textContent = "âš ï¸ Allow camera access in browser settings.";
  }
}

async function stopScanner() {
  if (isScanning) {
    await html5QrCode.stop();
    isScanning = false;
    startButton.disabled = false;
    stopButton.disabled = true;
    status.textContent = "Scanner stopped.";
  }
}

function sendToSheet(qrData) {
  fetch(GOOGLE_SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({ qrData }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.text())
  .then(data => {
    console.log("Sheet response:", data);
    status.textContent = "âœ… Data sent successfully!";
  })
  .catch(err => {
    console.error("Send error:", err);
    status.textContent = "âŒ Failed to send data to sheet.";
  });
}

startButton.addEventListener("click", async () => {
  // Request camera permission directly via user interaction
  await startScanner();
});

stopButton.addEventListener("click", stopScanner);
</script>
</body>
</html>
