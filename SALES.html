<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QR Sales Tracker (Multi-User)</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body {font-family: "Segoe UI", sans-serif; background:#f9fafb; text-align:center; padding:10px;}
  h2 {background:#1e3a8a; color:white; padding:8px; border-radius:6px;}
  #reader {width:100%; max-width:400px; margin:auto; border:2px solid #1e3a8a; border-radius:8px;}
  #result {margin-top:10px; font-weight:600; color:#1e3a8a;}
  button {background:#2563eb; color:white; padding:10px 15px; border:none; border-radius:6px; cursor:pointer; margin-top:10px;}
  button:hover {background:#1d4ed8;}
</style>
</head>
<body>
  <h2>üì¶ QR Sales Tracker (Multi-User)</h2>
  <p>Enter your name to identify scans:</p>
  <input type="text" id="username" placeholder="e.g. Devesh" style="padding:8px; width:70%; border:1px solid #ccc; border-radius:6px;">
  <div id="reader"></div>
  <p id="result">Waiting for scan...</p>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwhjdlWNyWQFsyURCjLMsZ30U2HPtbRULIuMHcesksjM5XB8IFB8Dh6nX4rTm4HJQEaOQ/exec"; // from Google Apps Script

function processLink(url) {
  try {
    const match = url.match(/\/d\/(.*)\/view/);
    if (!match) return null;
    const fileId = match[1];
    return {
      sku: fileId,
      imageUrl: `https://drive.google.com/uc?export=view&id=${fileId}`
    };
  } catch {
    return null;
  }
}

async function sendToGoogleSheet(data) {
  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" }
    });
    return await res.text();
  } catch (e) {
    console.error("Error:", e);
    return "Error";
  }
}

function onScanSuccess(decodedText) {
  const user = document.getElementById("username").value.trim();
  if (!user) {
    alert("Please enter your name first!");
    return;
  }

  const data = processLink(decodedText);
  if (!data) {
    document.getElementById("result").innerText = "‚ùå Invalid QR format";
    return;
  }

  const payload = {
    sku: data.sku,
    imageUrl: data.imageUrl,
    fullLink: decodedText,
    user
  };

  sendToGoogleSheet(payload).then(res => {
    document.getElementById("result").innerText = res === "Success"
      ? `‚úÖ Sale recorded for ${data.sku}`
      : `‚ö†Ô∏è Error saving data`;
  });
}

function onScanError(errorMessage) {
  console.warn(errorMessage);
}

const html5QrCode = new Html5Qrcode("reader");
html5QrCode.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: { width: 250, height: 250 } },
  onScanSuccess,
  onScanError
);
</script>
</body>
</html>
